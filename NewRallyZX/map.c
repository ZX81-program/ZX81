#include <stdio.h>
#include <string.h>

#include "map.h"
#include "scrn.h"


// map table

unsigned char maptbl[MAP_NUM][MAP_DY][MAP_DX] = {
 { // map1
  {0x00,0x80,0x7F,0x00},{0xEE,0x1B,0x78,0x7F},{0xEE,0x1B,0x79,0x00},{0x00,0x00,0x01,0x77},
  {0x7E,0x1F,0x78,0x77},{0x00,0x80,0x7B,0x00},{0xF0,0xEB,0x7B,0x7F},{0x04,0xEA,0x00,0x00},
  {0xF4,0xEA,0xEE,0xBF},{0x14,0xEA,0x0E,0xA0},{0xD4,0x0A,0x2E,0xA0},{0xD4,0xEA,0xAE,0xAF},
  {0x16,0xEA,0xAE,0xAF},{0xD6,0x0B,0x20,0xA0},{0x10,0xE8,0xE6,0xBC},{0xD6,0xEF,0xE6,0xBC},
  {0x06,0xE0,0xE6,0xBC},{0xFE,0xEF,0x00,0x80},{0xC0,0x00,0x00,0xDC},{0xDE,0xFE,0xFC,0xDC},
  {0x1E,0xE0,0xFC,0xC0},{0xDE,0xEE,0xC0,0x9C},{0xC0,0x0E,0xCC,0x9C},{0xFD,0xFE,0xCC,0xBC},
  {0x01,0x00,0x0C,0x80},{0xFD,0xFE,0xFC,0xBC},{0xFD,0xFE,0xFC,0xBC},{0x01,0x00,0x00,0x80},
  {0xDD,0xDE,0xDC,0xBC},{0xDD,0xDE,0xDC,0xBC},{0xDD,0x06,0xC0,0x8C},{0xDD,0xD6,0xDC,0xAC},
  {0x01,0xC0,0x1C,0xAC},{0xED,0xDE,0xC0,0x20},{0xEC,0xDE,0xDC,0x7C},{0x00,0xD8,0xDC,0x7C},
  {0xBC,0x03,0x00,0x00},{0xBC,0x03,0x00,0x00},{0x00,0x6E,0xF7,0x6C},{0xEC,0x6E,0xF7,0x6C},
  {0xEC,0x0E,0xF0,0x6C},{0xEC,0x6E,0x07,0x0C},{0x0C,0x60,0xD0,0x6C},{0xEC,0x7B,0xD7,0x6C},
  {0xEC,0x7B,0xD7,0x6C},{0x00,0x00,0x10,0x60},{0xBB,0x7D,0xD7,0x6C},{0xBB,0x7D,0xD7,0x6C},
  {0x03,0x00,0xC0,0x6C},{0xBB,0x55,0xD5,0x6C},{0xBB,0x55,0xD5,0x00},{0x30,0x54,0x15,0x7C},
  {0x86,0x55,0xD5,0x7C},{0xF6,0x55,0xD5,0x60},{0xF6,0x55,0xD5,0x6C},{0x00,0x00,0x00,0x0C}
 },
 { // map2
  {0xFF,0x1F,0x00,0x00},{0x01,0x50,0xF5,0x7B},{0xBD,0x57,0xF5,0x7B},{0x05,0x54,0x05,0x40},
  {0xB5,0x55,0x75,0x5B},{0x15,0x55,0x75,0x5B},{0x15,0x15,0x00,0x00},{0x55,0x55,0xDB,0x5F},
  {0x55,0x55,0x5B,0x40},{0x51,0x41,0x5B,0x5F},{0x55,0x55,0x5B,0x41},{0x15,0x15,0x00,0x5C},
  {0x15,0x55,0x5B,0x41},{0xB5,0x55,0x5B,0x5F},{0x05,0x54,0x5B,0x40},{0xBD,0x57,0xDB,0x5F},
  {0x01,0x10,0x00,0x00},{0xBF,0x5F,0xDB,0x5E},{0x00,0x40,0xDB,0x5E},{0xB5,0x77,0x03,0x40},
  {0xB5,0x77,0xDF,0x5B},{0xB5,0x77,0xDF,0x5B},{0xB5,0x77,0xDF,0x5B},{0x04,0x00,0xC0,0x5B},
  {0x74,0xEF,0x07,0x00},{0x74,0x83,0x00,0x00},{0x04,0xBB,0xDE,0x7D},{0x74,0xBB,0xDE,0x7D},
  {0x74,0x3B,0xDE,0x7D},{0x00,0x00,0x8E,0x0D},{0x74,0x3E,0xAE,0x6D},{0x74,0x3E,0xAE,0x6D},
  {0x14,0x38,0x00,0x60},{0x10,0x38,0xAE,0x6D},{0x94,0x39,0xAE,0x6D},{0x94,0x39,0x8E,0x0D},
  {0x14,0x00,0xDE,0x7D},{0xF4,0x37,0xDE,0x7D},{0x00,0x30,0x1E,0x00},{0xB6,0x35,0xDE,0x7F},
  {0xB6,0x05,0xC0,0x00},{0x00,0x70,0xDB,0x6E},{0xB6,0x75,0x18,0x60},{0xB6,0x75,0xDF,0x7F},
  {0x00,0x04,0x00,0x00},{0xB6,0x75,0xF7,0xDD},{0xB6,0x75,0xF7,0xDD},{0x00,0x00,0xC0,0xDD},
  {0xF7,0x56,0x15,0x00},{0xF7,0x54,0xD5,0x7D},{0xF7,0x55,0x15,0x00},{0x80,0x55,0xD5,0x6F},
  {0xB6,0x55,0x55,0x60},{0x36,0x00,0x40,0x6F},{0xB6,0x7D,0x5F,0x6F},{0x00,0x00,0x00,0x00}
 },
 { // map3
  {0x00,0x00,0x70,0x00},{0xFC,0x5E,0x75,0x77},{0x04,0x5E,0x05,0x07},{0x04,0x5E,0x75,0x77},
  {0x04,0x40,0x75,0x70},{0xFC,0x5B,0xF5,0x7D},{0xF0,0x1B,0xF0,0x7D},{0xF4,0x7B,0x07,0x00},
  {0x04,0x00,0xF7,0x4D},{0xB4,0x7B,0xF7,0x4D},{0xB4,0x7B,0x00,0x4C},{0x80,0x7B,0xF5,0x4D},
  {0xBE,0x7B,0xF5,0x4D},{0xBE,0x03,0xF5,0x0D},{0xBE,0x7B,0x35,0x40},{0xBE,0x7B,0xB4,0x4F},
  {0x00,0x78,0xB5,0x4F},{0xBE,0x7B,0xB5,0x4F},{0xBE,0x7B,0xB5,0x4F},{0xBE,0x03,0x00,0x00},
  {0xBE,0x6F,0xF0,0x36},{0x06,0xEC,0xFF,0x36},{0xE6,0x2C,0x80,0xB6},{0xE0,0xA0,0xB9,0xB6},
  {0x06,0x2C,0x80,0x86},{0xBE,0xAF,0xB9,0xBE},{0xBE,0x2F,0x80,0xBE},{0xBE,0xEF,0xF9,0x80},
  {0x00,0xE0,0xF9,0xBE},{0x00,0xE0,0xF9,0xBE},{0xB6,0x0D,0x00,0x00},{0xB6,0x0D,0x00,0x00},
  {0xB6,0xED,0x7B,0x7F},{0xB0,0xE1,0x7B,0x7F},{0xBE,0xF7,0x7B,0x78},{0xBE,0xF7,0x60,0x7B},
  {0x00,0x00,0x6E,0x63},{0xBE,0xF7,0x0E,0x6F},{0xBE,0xF7,0x60,0x0F},{0xB0,0xF1,0x6E,0x7F},
  {0xB6,0x1D,0x6E,0x7F},{0xB6,0xC1,0x00,0x00},{0xB6,0xED,0xDE,0x7B},{0x06,0xEC,0xDE,0x7B},
  {0xBE,0x01,0xD8,0x7B},{0xBE,0x75,0x1B,0x00},{0x00,0x74,0xDB,0x7F},{0xFE,0x05,0x00,0x00},
  {0xFE,0x55,0xD5,0x7D},{0x0E,0x54,0x55,0x04},{0xEE,0x55,0x55,0x55},{0xE0,0x55,0x55,0x55},
  {0xFE,0x55,0x55,0x55},{0x0E,0x00,0x40,0x41},{0xEE,0xFD,0x5D,0x5F},{0x00,0x00,0x00,0x00}
 },
 { // map4
  {0x00,0x00,0x00,0x00},{0xFE,0x1E,0xB8,0x7F},{0xF8,0x1E,0xB8,0x7F},{0xF2,0x1E,0x38,0x00},
  {0xE6,0x5E,0x7A,0x2F},{0x0E,0x58,0x7A,0x2F},{0xDE,0x5B,0x7A,0x2F},{0xDE,0x41,0x02,0x2E},
  {0xDE,0x5D,0xFA,0x2E},{0xDE,0x59,0xFA,0x2E},{0xC0,0x5B,0xFA,0x2E},{0xEE,0x1B,0xF8,0x20},
  {0x0E,0x78,0xFE,0x2D},{0xBE,0x7B,0xFE,0x2D},{0xBE,0x0B,0xF0,0x2D},{0xBE,0x0B,0xF0,0x0D},
  {0xBE,0xCB,0xF3,0x3D},{0x00,0xC0,0x03,0x00},{0x00,0xC0,0x03,0x7A},{0xBB,0xCF,0xB3,0x78},
  {0xBB,0x0F,0xB0,0x7B},{0xBB,0x0F,0x10,0x42},{0x00,0x78,0xDE,0x5E},{0xBB,0x7B,0xC6,0x00},
  {0xBB,0x7B,0xF6,0x5B},{0xBB,0x7B,0x76,0x58},{0x03,0x00,0x76,0x5F},{0xBB,0x6B,0x76,0x5F},
  {0xBB,0x6B,0x76,0x5F},{0xB0,0x6B,0x76,0x5F},{0x06,0x00,0x00,0x0F},{0x06,0x70,0x76,0x6F},
  {0xF6,0x77,0x76,0x0F},{0x04,0x74,0x76,0xEF},{0xE4,0x74,0x36,0xEC},{0x04,0x74,0xB6,0xE1},
  {0xF4,0x04,0xB6,0xFD},{0x80,0x74,0x80,0xFD},{0xB4,0x74,0x36,0x00},{0xB4,0x74,0xB6,0x7D},
  {0xA4,0x74,0xB6,0x1D},{0xAC,0x74,0x06,0x5C},{0xAC,0x74,0xB6,0x5D},{0x8E,0x74,0xB6,0x01},
  {0xBE,0x74,0xF6,0x7D},{0xBE,0x74,0xF6,0x45},{0x02,0x00,0x00,0x50},{0xAA,0x54,0xD5,0x56},
  {0xAA,0x54,0xD5,0x56},{0xA8,0x54,0xD5,0x46},{0xAE,0x54,0xD5,0x56},{0xA0,0x54,0xD5,0x56},
  {0xBE,0x04,0xC0,0x56},{0xBE,0xF4,0xDF,0x06},{0x80,0x04,0x00,0x7E},{0x00,0x00,0x00,0x00}
 }
};


// flag table

struct FLAGTBL flagtbl[MAP_NUM][FLAG_NUM] = {
 { // map1
  {14, {{ 4, 0},{25, 0},{28, 0},{31, 0},{ 8, 3},{31, 4},{ 1, 5},{14, 5},{24, 5},{29, 5},{12, 6},{23, 6},{ 6, 7},{20, 7}}},
  {17, {{12, 8},{ 1, 9},{10, 9},{ 3,10},{ 5,10},{23,10},{ 0,11},{12,11},{28,11},{ 7,12},{17,13},{ 5,14},{ 9,14},{ 9,16},{30,16},{21,17},{15,18}}},
  {17, {{27,20},{12,21},{ 3,22},{29,22},{ 1,23},{24,23},{ 6,24},{ 1,25},{10,27},{29,27},{ 5,28},{17,28},{ 1,30},{16,31},{24,31},{28,31},{30,32}}},
  {17, {{21,33},{ 6,35},{25,35},{21,36},{30,36},{17,37},{23,37},{ 5,38},{ 7,38},{19,38},{12,39},{ 0,41},{22,41},{28,41},{ 9,42},{12,42},{25,42}}},
  {17, {{15,43},{ 5,45},{10,45},{21,45},{31,45},{ 2,48},{ 8,48},{ 6,49},{24,49},{ 0,51},{ 3,51},{ 6,51},{24,51},{12,55},{16,55},{19,55},{21,55}}}
 },
 { // map2
  {15, {{30, 0},{31, 0},{ 8, 1},{ 1, 3},{ 6, 3},{22, 3},{28, 3},{31, 5},{ 3, 6},{ 6, 6},{18, 6},{19, 6},{23, 6},{ 1, 7},{27, 8}}},
  {15, {{ 1, 9},{13, 9},{ 7,10},{21,10},{20,11},{ 1,12},{ 6,12},{ 7,12},{13,14},{ 6,16},{18,16},{21,16},{10,18},{11,18},{21,18}}},
  {14, {{ 6,19},{25,19},{27,19},{28,19},{ 8,23},{16,23},{12,24},{30,24},{ 1,25},{13,25},{26,25},{ 6,26},{ 3,29},{22,30}}},
  {15, {{ 0,31},{ 8,31},{24,32},{25,32},{ 0,33},{ 7,33},{ 0,34},{ 0,35},{ 6,35},{29,35},{13,36},{21,36},{21,37},{ 7,38},{11,41}}},
  {14, {{ 3,43},{ 9,43},{ 9,44},{15,44},{ 3,45},{ 9,45},{29,45},{ 0,47},{ 6,52},{28,54},{ 5,55},{ 8,55},{12,55},{20,55}}}
 },
 { // map3
  {13, {{ 1, 0},{28, 0},{30, 0},{ 0, 1},{22, 2},{ 6, 3},{ 0, 6},{20, 7},{19, 8},{31, 8},{ 1, 9},{ 0,12},{19,12}}},
  {13, {{15,13},{17,13},{25,13},{28,13},{ 6,14},{10,18},{12,19},{25,19},{27,19},{28,19},{18,22},{ 1,23},{18,23}}},
  {13, {{ 6,24},{12,24},{22,24},{14,25},{19,26},{30,26},{28,27},{29,27},{ 6,28},{ 8,28},{ 6,30},{22,31},{31,34}}},
  {12, {{26,35},{ 0,36},{ 5,36},{13,36},{26,36},{30,38},{13,40},{ 6,41},{11,41},{26,41},{ 3,43},{ 9,43}}},
  {13, {{13,44},{15,44},{ 9,45},{30,45},{25,49},{28,49},{29,49},{21,52},{ 4,53},{ 4,54},{ 9,54},{12,55},{25,55}}}
 },
 { // map4
  {15, {{ 9, 0},{20, 0},{26, 0},{ 8, 1},{ 8, 2},{ 0, 3},{26, 3},{23, 4},{ 7 ,5},{15, 5},{13, 9},{28, 9},{ 2,10},{18,10},{31,10}}},
  {15, {{10,11},{26,11},{28,11},{16,12},{10,13},{16,13},{25,13},{18,15},{31,16},{ 1,17},{13,18},{24,18},{31,18},{12,19},{26,19}}},
  {14, {{29,22},{24,23},{24,25},{ 7,26},{ 9,26},{14,26},{16,28},{ 5,31},{ 8,31},{ 9,31},{10,31},{16,31},{30,32},{25,35}}},
  {15, {{19,36},{ 9,37},{17,37},{22,37},{ 9,38},{16,38},{ 1,39},{ 9,40},{30,40},{15,41},{11,42},{19,42},{ 8,43},{ 9,44},{19,44}}},
  {15, {{ 0,46},{ 8,46},{ 8,47},{24,47},{24,49},{ 4,50},{ 8,50},{ 6,51},{29,52},{21,53},{ 0,54},{ 2,55},{12,55},{16,55},{20,55}}}
 }
};


// rock table

struct ROCKTBL rocktbl[MAP_NUM][ROCK_NUM] = {
 { // map1
  {4, {{11, 5},{23, 5},{ 1,14},{20,14}}},
  {4, {{ 5,15},{24,17},{ 6,20},{30,21}}},
  {4, {{20,22},{17,27},{ 1,29},{11,32}}},
  {4, {{ 1,35},{ 1,38},{ 7,42},{ 6,52}}}
 },
 { // map2
  {4, {{23, 3},{22,11},{31,11},{20,16}}},
  {4, {{ 1,24},{21,24},{ 1,27},{15,29}}},
  {4, {{31,32},{12,36},{19,40},{26,40}}},
  {4, {{3, 41},{23,48},{29,50},{ 7,53}}}
 },
 { // map3
  {4, {{27, 2},{ 8, 3},{12, 8},{28, 8}}},
  {4, {{ 0,10},{30,13},{17,14},{ 6,19}}},
  {4, {{30,20},{31,30},{17,31},{12,33}}},
  {4, {{ 0,37},{20,37},{31,43},{ 7,46}}}
 },
 { // map4
  {4, {{10, 0},{31, 4},{13, 7},{ 4,11}}},
  {4, {{24,17},{19,18},{ 6,20},{16,22}}},
  {4, {{11,30},{15,33},{ 0,34},{ 8,35}}},
  {4, {{25,38},{ 1,49},{30,53},{ 9,55}}}
 }
};


// character table

unsigned char chrtbl[CHR_NUM][CHR_DY][CHR_DX] = {
 // CHR_SPC
 {{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00}},
 // CHR_NFLAG
 {{0x00,0x80,0x04},{0x00,0x05,0x00},{0x02,0x03,0x00}},
 // CHR_SFLAG
 {{0x38,0x80,0x04},{0x00,0x05,0x00},{0x02,0x03,0x00}},
 // CHR_LFLAG
 {{0x31,0x80,0x04},{0x00,0x05,0x00},{0x02,0x03,0x00}},
 // CHR_ROCK
 {{0x81,0x89,0x04},{0x8A,0x80,0x05},{0x03,0x03,0x01}},
 // CHR_SMOKE
 {{0x09,0x0a,0x09},{0x09,0x0a,0x09},{0x00,0x0a,0x00}},
 // CHR_BLK
 {{0x06,0x07,0x04},{0x07,0x06,0x05},{0x02,0x03,0x00}},
 {{0x07,0x06,0x05},{0x07,0x06,0x05},{0x02,0x03,0x00}},
 {{0x06,0x07,0x04},{0x07,0x06,0x05},{0x07,0x06,0x05}},
 {{0x07,0x06,0x05},{0x07,0x06,0x05},{0x07,0x06,0x05}},
 {{0x07,0x07,0x04},{0x06,0x06,0x05},{0x03,0x03,0x00}},
 {{0x06,0x06,0x05},{0x06,0x06,0x05},{0x03,0x03,0x00}},
 {{0x07,0x07,0x04},{0x06,0x06,0x05},{0x06,0x06,0x05}},
 {{0x06,0x06,0x05},{0x06,0x06,0x05},{0x06,0x06,0x05}},
 {{0x06,0x07,0x07},{0x07,0x06,0x06},{0x02,0x03,0x03}},
 {{0x07,0x06,0x06},{0x07,0x06,0x06},{0x02,0x03,0x03}},
 {{0x06,0x07,0x07},{0x07,0x06,0x06},{0x07,0x06,0x06}},
 {{0x07,0x06,0x06},{0x07,0x06,0x06},{0x07,0x06,0x06}},
 {{0x07,0x07,0x07},{0x06,0x06,0x06},{0x03,0x03,0x03}},
 {{0x06,0x06,0x06},{0x06,0x06,0x06},{0x03,0x03,0x03}},
 {{0x07,0x07,0x07},{0x06,0x06,0x06},{0x06,0x06,0x06}},
 {{0x06,0x06,0x06},{0x06,0x06,0x06},{0x06,0x06,0x06}}
};


// field table

#define FLD_DX      MAP_DX * 8
#define FLD_DY      MAP_DY

unsigned char fldtbl[FLD_DY][FLD_DX];


// randum

static unsigned char randum_val;


void makefld(unsigned char *maptblp)
{
    #asm

        ld      ix,2
        add     ix,sp
;
;uncompress
;
        ld      b, MAP_DX
        ld      c, MAP_DY
        ld      e, (ix+0)
        ld      d, (ix+1)       ; de=maptblp
        ld      hl,_fldtbl      ; hl=fldtbl

makefld_uncompress_yloop:
        push    bc

makefld_uncompress_xloop:
        ld      c,1             ; check bit

makefld_uncompress_bitloop:
        ld      a,(de)
        and     c
        ld      a,CHR_SPC
        jp      z, makefld_uncompress_bitzero
        ld      a,CHR_BLK
makefld_uncompress_bitzero:
        ld      (hl),a

        inc     hl
        rlc     c
        jp      nc, makefld_uncompress_bitloop

        inc     de
        djnz    makefld_uncompress_xloop

        pop     bc
        dec     c
        jp      nz, makefld_uncompress_yloop

;
;set block
;
        ld      b,0             ; field x counter
        ld      c,0             ; field y counter
        ld      de,FLD_DX
        ld      hl,_fldtbl      ; hl=fldtblp

makefld_setblock_loop:
        ld      a,(hl)
        cp      a,CHR_SPC
        jp      z,makefld_setblock_next

makefld_setleft:
        ld      a, b
        dec     a
        cp      FLD_DX
        jp      nc,makefld_setleft_rangeover
        dec     hl
        ld      a,(hl)
        inc     hl
        cp      a,CHR_SPC
        jp      z,makefld_setright
makefld_setleft_rangeover:
        ld      a,(hl)
        add     a,CHRBIT_LT
        ld      (hl),a

makefld_setright:
        ld      a, b
        inc     a
        cp      FLD_DX
        jp      nc,makefld_setright_rangeover
        inc     hl
        ld      a,(hl)
        dec     hl
        cp      a,CHR_SPC
        jp      z,makefld_settop
makefld_setright_rangeover:
        ld      a,(hl)
        add     a,CHRBIT_RT
        ld      (hl),a

makefld_settop:
        ld      a, c
        dec     a
        cp      FLD_DY
        jp      nc,makefld_settop_rangeover
        xor     0   ;cf=0
        sbc     hl,de
        ld      a,(hl)
        add     hl,de
        cp      a,CHR_SPC
        jp      z,makefld_setbottom
makefld_settop_rangeover:
        ld      a,(hl)
        add     a,CHRBIT_UP
        ld      (hl),a

makefld_setbottom:
        ld      a, c
        inc     a
        cp      FLD_DY
        jp      nc,makefld_setbottom_rangeover
        xor     0   ;cf=0
        add     hl,de
        ld      a,(hl)
        sbc     hl,de
        cp      a,0
        jp      z,makefld_setblock_next
makefld_setbottom_rangeover:
        ld      a,(hl)
        add     a,CHRBIT_DN
        ld      (hl),a

makefld_setblock_next:
        inc     hl

        inc     b
        ld      a,b
        cp      a,FLD_DX
        jp      nz,makefld_setblock_loop

        ld      b,0

        inc     c
        ld      a,c
        cp      a,FLD_DY
        jp      nz,makefld_setblock_loop

    #endasm
}

unsigned char randum()
{
    #asm
        ld      a, (_randum_val)

	    rlca
	    rlca
	    rlca
	    rlca
	    ld	l,a
	    ld	a,r
	    add	a,l
	    ld	(_randum_val),a

	    ld	h,0
	    ld	l,a

	    ret
    #endasm
}

void makemap(int mapno, int rocknum)
{
    int  i, n, r1, r2;
    int  y, x;

    // initialize
    memset(&fldtbl[0][0], 0, sizeof(fldtbl));

    // param check
    if ((mapno < 1) || (mapno > MAP_NUM)) {
        mapno = 1;
    }

    // make field
    makefld(&maptbl[mapno-1][0][0]);

    // set flag
    for (i = 0; i < FLAG_MAX; i++) {
        while (1) {
            r1 = randum() % FLAG_NUM;
            r2 = randum() % flagtbl[mapno-1][r1].num;
            y = flagtbl[mapno-1][r1].pos[r2].y;
            x = flagtbl[mapno-1][r1].pos[r2].x;
            if (fldtbl[y][x] == 0) {
                break;
            }
        }
        switch (i) {
            case 0:
                n = CHR_SFLAG;
                break;
            case 1:
                n = CHR_LFLAG;
                break;
            default:
                n = CHR_NFLAG;
                break;
        }
        fldtbl[y][x] = n;
        setradar(y, x, ON);
    }

    // set rock
    for (i = 0; i < rocknum; i++) {
        while (1) {
            r1 = randum() % ROCK_NUM;
            r2 = randum() % rocktbl[mapno-1][r1].num;
            y = rocktbl[mapno-1][r1].pos[r2].y;
            x = rocktbl[mapno-1][r1].pos[r2].x;
            if (fldtbl[y][x] == 0) {
                break;
            }
        }
        fldtbl[y][x] = CHR_ROCK;
    }
}

unsigned char getfldchr(int fldy, int fldx)
{
    #asm
        ld      ix,2
        add     ix,sp

        ld      e, (ix+0)       ; fldx
        ld      d, (ix+2)       ; fldy

        ld      a, e
        cp      FLD_DX
        jp      nc,getfldchr_retblk
        ld      a, d
        cp      FLD_DY
        jp      nc,getfldchr_retblk

        ld      hl,_fldtbl      ; hl=fldtbl

;        ld      bc,FLD_DX
;
;        ld      a,d
;        cp      0
;getfldchr_addy:
;        jp      z,getfldchr_addx
;        add     hl,bc
;        dec     a
;        jp      getfldchr_addy
;getfldchr_addx:
;        ld      c,e
;        ld      b,0
;        add     hl,bc

        ld      c,e
        ld      b,0
        add     hl,bc

        ld      c,d
        and     0
        sla     c  ; x2
        adc     a,a
        sla     c  ; x4
        adc     a,a
        sla     c  ; x8
        adc     a,a
        sla     c  ; x16
        adc     a,a
        sla     c  ; x32
        adc     a,a
        ld      b,a
        add     hl,bc

        ld      a,(hl)
        ld      l,a
        ld      h,0
        ret

getfldchr_retblk:
        ld      hl,CHR_BLK
        ret

    #endasm
}

unsigned char getflddir(int fldy, int fldx)
{
    #asm
        ld      ix,2
        add     ix,sp

        ld      e, (ix+0)       ; fldx
        ld      d, (ix+2)       ; fldy

        ld      a, e
        cp      FLD_DX
        jp      nc,getflddir_retnone
        ld      a, d
        cp      FLD_DY
        jp      nc,getflddir_retnone

        ld       hl,_fldtbl     ; hl=fldtbl
;        ld      bc,FLD_DX
;
;        ld      a,d
;        cp      0
;getflddir_addy:
;        jp      z,getflddir_addx
;        add     hl,bc
;        dec     a
;        jp      getflddir_addy
;getflddir_addx:
;        ld      c,e
;        ld      b,0
;        add     hl,bc

        ld      c,e
        ld      b,0
        add     hl,bc

        ld      c,d
        and     0
        sla     c  ; x2
        adc     a,a
        sla     c  ; x4
        adc     a,a
        sla     c  ; x8
        adc     a,a
        sla     c  ; x16
        adc     a,a
        sla     c  ; x32
        adc     a,a
        ld      b,a
        add     hl,bc

; get movable directions of the field
        ld      b,0     ; •ûŒü(DIR_UP|DIR_DN|DIR_LT|DIR_RT)
        ld      c,0     ; •ûŒü”(0`4)

getflddir_up:
        ld      a, d
        dec     a
        cp      FLD_DY
        jp      nc,getflddir_dn

        push    hl
        push    bc
        ld      bc,FLD_DX
        or      a
        sbc     hl,bc
        ld      a,(hl)
        pop     bc
        pop     hl

        cp      CHR_BLK
        jp      nc,getflddir_dn

        ld      a,DIR_UP
        add     a,b
        ld      b,a
        inc     c

getflddir_dn:
        ld      a, d
        inc     a
        cp      FLD_DY
        jp      nc,getflddir_lt

        push    hl
        push    bc
        ld      bc,FLD_DX
        add     hl,bc
        ld      a,(hl)
        pop     bc
        pop     hl

        cp      CHR_BLK
        jp      nc,getflddir_lt

        ld      a,DIR_DN
        add     a,b
        ld      b,a
        inc     c

getflddir_lt:
        ld      a, e
        dec     a
        cp      FLD_DX
        jp      nc,getflddir_rt

        push    hl
        dec     hl
        ld      a,(hl)
        pop     hl

        cp      CHR_BLK
        jp      nc,getflddir_rt

        ld      a,DIR_LT
        add     a,b
        ld      b,a
        inc     c

getflddir_rt:
        ld      a, e
        inc     a
        cp      FLD_DX
        jp      nc,getflddir_ret

        push    hl
        inc     hl
        ld      a,(hl)
        pop     hl

        cp      CHR_BLK
        jp      nc,getflddir_ret

        ld      a,DIR_RT
        add     a,b
        ld      b,a
        inc     c

getflddir_ret:
        ld      l,b
        ld      h,c
        ret

getflddir_retnone:
        ld      l,DIR_NONE
        ld      h,0
        ret

    #endasm
}
