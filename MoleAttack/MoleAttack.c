#include <input.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define D_FILE 0x400c

#define D_DY   (32 + 1)

#define CHR_HOLE		0
#define CHR_HAMMER_DSP	1
#define CHR_HAMMER_CLR	2
#define CHR_HEAD1		3
#define CHR_HEAD2		4
#define CHR_HEAD3		5
#define CHR_HEAD4		6
#define CHR_HEAD_CLR	7
#define CHR_HIP1		8
#define CHR_HIP2		9
#define CHR_HIP3		10
#define CHR_HIP4		11
#define CHR_HIP_CLR		12
#define CHR_HEAD1_HIT	13
#define CHR_HEAD2_HIT	14
#define CHR_HEAD3_HIT	15
#define CHR_HEAD4_HIT	16
#define CHR_HIP1_HIT	17
#define CHR_HIP2_HIT	18
#define CHR_HIP3_HIT	19
#define CHR_HIP4_HIT	20

#define CHR_DX			7
#define CHR_DY			7

static unsigned char chrtbl[][CHR_DX*CHR_DY] = {
//0: hole
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x08, 0x08, 0x09, 0x09, 0x09, 0x08, 0x08},
//1: hammer display
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x08, 0x09, 0x09, 0x09, 0x08, 0x08},
//2: hummer clear
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x08, 0x09, 0x09, 0x09, 0x08, 0x08},
//3: head1
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x87, 0xB4, 0x80, 0xB4, 0x04, 0x00,
     0x00, 0x85, 0x94, 0xa8, 0x94, 0x05, 0x00,
     0x00, 0x85, 0x8B, 0x80, 0x8B, 0x05, 0x00,
     0x00, 0x85, 0x80, 0x80, 0x80, 0x05, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//4: head2
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x87, 0xB4, 0x80, 0xB4, 0x04, 0x00,
     0x00, 0x85, 0x94, 0xa8, 0x94, 0x05, 0x00,
     0x00, 0x85, 0x8B, 0x80, 0x8B, 0x05, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//5: head3
    {0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x87, 0xB4, 0x80, 0xB4, 0x04, 0x00,
     0x00, 0x85, 0x94, 0xa8, 0x94, 0x05, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//6: head4
    {0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x87, 0xB4, 0x80, 0xB4, 0x04, 0x00,
     0x88, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//7: head clear
    {0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x08, 0x08, 0x09, 0x09, 0x09, 0x08, 0x08},
//8: hip1
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00,
     0x00, 0x87, 0x80, 0x80, 0x80, 0x04, 0x00,
     0x00, 0x85, 0x80, 0x80, 0x80, 0x05, 0x00,
     0xff, 0x85, 0x80, 0x80, 0x80, 0x05, 0x00,
     0xff, 0x85, 0x80, 0x80, 0x80, 0x05, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//9: hip2
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00,
     0x00, 0x87, 0x80, 0x80, 0x80, 0x04, 0x00,
     0x00, 0x85, 0x80, 0x80, 0x80, 0x05, 0x00,
     0xff, 0x85, 0x80, 0x80, 0x80, 0x05, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//10: hip3
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00,
     0x00, 0x87, 0x80, 0x80, 0x80, 0x04, 0x00,
     0x00, 0x85, 0x80, 0x80, 0x80, 0x05, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//11: hip4
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00,
     0x00, 0x87, 0x80, 0x80, 0x80, 0x04, 0x00,
     0x88, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//12: hip clear
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x08, 0x08, 0x09, 0x09, 0x09, 0x08, 0x08},
//13: head1 hit
	{0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x87, 0x92, 0x80, 0x93, 0x04, 0x00,
     0x00, 0x80, 0x94, 0xa8, 0x94, 0x80, 0x00,
     0x00, 0x80, 0x80, 0xbd, 0x80, 0x80, 0x00,
     0x00, 0x84, 0x80, 0x80, 0x80, 0x07, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//14: head2 hit
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x87, 0x92, 0x80, 0x93, 0x04, 0x00,
     0x00, 0x80, 0x94, 0xa8, 0x94, 0x80, 0x00,
     0x00, 0x80, 0x80, 0xbd, 0x80, 0x80, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//15: head3 hit
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x87, 0x92, 0x80, 0x93, 0x04, 0x00,
     0x00, 0x80, 0x94, 0xa8, 0x94, 0x80, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//16: head4 hit
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x81, 0x92, 0x80, 0x93, 0x82, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//17: hip1 hit
	{0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x87, 0x80, 0x80, 0x80, 0x04, 0x00,
     0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
     0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
     0x00, 0x84, 0x80, 0x80, 0x80, 0x07, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//18: hip2 hit
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x87, 0x80, 0x80, 0x80, 0x04, 0x00,
     0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
     0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//19: hip3 hit
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x87, 0x80, 0x80, 0x80, 0x04, 0x00,
     0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88},
//20: hip4 hit
	{0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x02, 0x89, 0x03, 0x03, 0x00,
     0x00, 0x81, 0x80, 0x80, 0x80, 0x82, 0x00,
     0xff, 0x88, 0x89, 0x89, 0x89, 0x88, 0x88}
};

#define MOT_NUM		2
#define MOT_HEAD	0
#define MOT_HIP		1

struct {
	int molechr[MOT_NUM];
	int hitchr[MOT_NUM];
	int point[MOT_NUM];
} motiontbl[] = {
	{{CHR_HEAD4, CHR_HIP4}, {CHR_HEAD4_HIT, CHR_HIP4_HIT}, {40, -40}},
	{{CHR_HEAD3, CHR_HIP3}, {CHR_HEAD3_HIT, CHR_HIP3_HIT}, {30, -30}},
	{{CHR_HEAD2, CHR_HIP2}, {CHR_HEAD2_HIT, CHR_HIP2_HIT}, {20, -20}},
	{{CHR_HEAD1, CHR_HIP1}, {CHR_HEAD1_HIT, CHR_HIP1_HIT}, {10, -10}},
	{{CHR_HEAD1, CHR_HIP1}, {CHR_HEAD1_HIT, CHR_HIP1_HIT}, {10, -10}},
	{{CHR_HEAD2, CHR_HIP2}, {CHR_HEAD2_HIT, CHR_HIP2_HIT}, {20, -20}},
	{{CHR_HEAD3, CHR_HIP3}, {CHR_HEAD3_HIT, CHR_HIP3_HIT}, {30, -30}},
	{{CHR_HEAD4, CHR_HIP4}, {CHR_HEAD4_HIT, CHR_HIP4_HIT}, {40, -40}},
	{{CHR_HEAD_CLR, CHR_HIP_CLR}, {-1, -1}, {0, 0}}
};

struct {
	int posx;
	int posy;
	int key;
	int press;
	int action;
	int motion;
	int wait;
} holeinfo[] = {
	{ 0,  0, 0x08ef, 0, 0, 0, 0}, { 8,  0, 0x04ef, 0, 0, 0, 0}, {16,  0, 0x02ef, 0, 0, 0, 0},
	{ 0,  7, 0x08f7, 0, 0, 0, 0}, { 8,  7, 0x10f7, 0, 0, 0, 0}, {16,  7, 0x10ef, 0, 0, 0, 0},
	{ 0, 14, 0x01f7, 0, 0, 0, 0}, { 8, 14, 0x02f7, 0, 0, 0, 0}, {16, 14, 0x04f7, 0, 0, 0, 0}
};


unsigned char *scrnlinep[24];

#define _countof(array)    (sizeof(array) / sizeof(array[0]))

void dispmole(int posno, int chrno)
{
    unsigned char *p, *cp;
    int  x, y, i;

	if ((posno < 0) || (posno >= _countof(holeinfo))) {
		return;
	}
	if ((chrno < 0) || (chrno >= _countof(chrtbl))) {
		return;
	}
	x = holeinfo[posno].posx;
	y = holeinfo[posno].posy;
	
	p = scrnlinep[y]+ x;
    cp = &chrtbl[chrno][0];
	for (i = 0; i < CHR_DY; i++) {
		if (cp[0] != 0xff) {
			memcpy(p, cp, CHR_DX);
		}
		p += D_DY;
		cp += CHR_DX;
	}
}

int main()
{
	int  i;
	int  motion, direction;

    srand((unsigned int)clock());

	for (i = 0; i < _countof(scrnlinep); i++) {
		scrnlinep[i] = (unsigned char *)((*((unsigned int *)D_FILE) + 1 + i * D_DY));
    }

	for (i = 0; i < _countof(holeinfo); i++) {
		dispmole(i, CHR_HOLE);
	}

	while (in_KeyPressed(0x01bf) == 0) {     // press enter to exit
		if (rand() % 10 <= 1) {
			i = rand() % _countof(holeinfo);
			if (holeinfo[i].action == 0) {
				holeinfo[i].action = rand() % 2 + 1;
				holeinfo[i].motion = 0;
				holeinfo[i].wait = 0;
			}
		}

		for (i = 0; i < _countof(holeinfo); i++) {
			if (holeinfo[i].wait > 0) {
				holeinfo[i].wait--;
			}
			else {
				switch (holeinfo[i].action) {
					case 0:
						break;

					case 1:
					case 2:
					    motion = holeinfo[i].motion;
					    direction = holeinfo[i].action-1;
						dispmole(i, motiontbl[motion].molechr[direction]);
						holeinfo[i].motion++;
						if (holeinfo[i].motion < _countof(motiontbl)) {
							holeinfo[i].wait = 4;
						}
						else {
						    holeinfo[i].motion = 0;
							holeinfo[i].action = 0;
						}
						break;

					default:
						if (holeinfo[i].action == 3) {
							dispmole(i, CHR_HAMMER_CLR);
							holeinfo[i].motion = 0;
							holeinfo[i].action = 0;
						}
						if (holeinfo[i].action == 4) {
							dispmole(i, CHR_HOLE);
							holeinfo[i].motion = 0;
							holeinfo[i].action = 0;
						}
						break;
				}
			}

			if (in_KeyPressed(holeinfo[i].key) != 0) {
				if (holeinfo[i].press == 0) {
					switch (holeinfo[i].action) {
						case 0: // 空振り
							dispmole(i, CHR_HAMMER_DSP);
							holeinfo[i].press = 1;
							holeinfo[i].action = 3;
							holeinfo[i].wait = 2;		// すぐには消さない
							break;
						
						case 1:
						case 2:
						    motion = holeinfo[i].motion-1;
						    direction = holeinfo[i].action-1;
							dispmole(i, motiontbl[motion].hitchr[direction]);
							holeinfo[i].press = 1;
							holeinfo[i].action = 4;
							holeinfo[i].wait = 4;		// すぐには消さない
							break;
					}
				}
	        }
			else {
				holeinfo[i].press = 0;
			}
		}

        in_Wait(10);    // wait(msec)
	}

	return (0);
}
